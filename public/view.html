<!DOCTYPE html>
<html lang="en">
  <head>
    <title>CS4241 Assignment 3 - Persistence</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="stylesheets/style.css" type="text/css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  </head>

  <body id="viewBody">
    <h1>
      Travel Destinations
    </h1>
    <button type="button" id="homePage">
      Home Page
    </button>
    <button type="button" id="addButton">
      Add Destinations</button
    ><br /><br />
    <div id="viewPage">Destinations:</div>
    <div id="viewBottom">Travel Destination Site</div>
  </body>

  <script>
    function insertAfter(el, referenceNode) {
      referenceNode.parentNode.insertBefore(el, referenceNode.nextSibling);
    }
    $("#addButton").click(function() {
      window.location.href = "sites.html";
    });
    $("#homePage").click(function() {
      window.location.href = "index.html";
    });

    fetch("/view", {
      method: "GET",
      headers: { "Content-Type": "application/json" }
    })
      .then(function(response) {
        return response.text();
      })
      .then(text => showDest(text));

    function showDest(text) {
      let data = JSON.parse(text);
      let currentDiv = document.getElementById("viewPage");
      for (let i = 0; i < data.length; i++) {
        let city = data[i].city;
        let state_ = data[i].state_;
        let desc = data[i].desc;
        let rating = data[i].rating;
        let user_ = data[i].user_;
        let uid = data[i].uid;

        let space = document.createTextNode("<br/>");
        let newDiv = document.createElement("div");

        let newcityDiv = document.createElement("div");
        let newdescDiv = document.createElement("div");
        let newrateDiv = document.createElement("div");

        let removeButton = document.createElement("button");

        newDiv.setAttribute("class", "viewer");
        newDiv.setAttribute("class", "flex-container");

        removeButton.setAttribute("id", uid);
        removeButton.setAttribute("class", "removeButton");

        newcityDiv.innerHTML = "<p>" + city + ", " + state_ + "</p>";
        newdescDiv.innerHTML = "<p>" + desc + "</p>";
        newrateDiv.innerHTML =
          "<p>" + "Rated " + rating + "/5 by " + user_ + "</p>" + "<br/>";
        removeButton.innerHTML = "<p>" + "Remove" + "</p>";
        newDiv.appendChild(newcityDiv);
        newDiv.appendChild(newdescDiv);
        newDiv.appendChild(newrateDiv);

        fetch("/usernameget", {
          method: "GET",
          headers: { "Content-Type": "application/json" }
        })
          .then(function(response) {
            return response.text();
          })
          .then(text => removeadd(text));

        function removeadd(text) {
          let dataparsed = JSON.parse(text);
          currentusername = dataparsed[0].username;
          if (currentusername == user_ || currentusername == "admin") {
            newDiv.appendChild(removeButton);
          }
        }

        console.log(newDiv);
        insertAfter(newDiv, currentDiv);
        currentDiv = newDiv;
      }
    }

    $(document).on("click", ".removeButton", function() {
      data = {
        uid: this.id
      };

      fetch("/remLoc", {
        method: "POST",
        body: JSON.stringify(data),
        headers: { "Content-Type": "application/json" }
      })
        .then(console.log)
        .catch(err => console.error);

      parent = document.getElementById("viewBody");
      child = document.getElementById(this.id).parentNode;
      parent.removeChild(child);
    });
  </script>
</html>
